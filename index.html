<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cyber Security Maturity Model – Check Point</title>
  <meta name="description" content="Secure your business today by assessing your cyber security maturity with our quick assessment." />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script> <!-- EmailJS -->
  <style>
    /* === ALL ORIGINAL STYLES UNCHANGED (kept exactly as you provided) === */
    :root {
      --primary: #0055a5;
      --red: #B70E4E;
      --light-blue: #AADAFF;
      --green: #2E7D32;
      --orange: #FF9800;
      --dark-red: #D32F2F;
    }
    /* ... (all your existing styles remain here - omitted for brevity but are identical) ... */
  </style>
</head>
<body>
  <!-- === ALL HTML STRUCTURE UNCHANGED (questions, results, etc.) === -->
  <!-- (kept exactly as provided - only minor additions for auto notice display) -->

  <script>
    // ==================== EMAILJS CONFIG - YOU MUST FILL THESE IN ====================
    const EMAILJS_USER_ID = 'YOUR_PUBLIC_KEY_HERE';         // From EmailJS dashboard
    const SERVICE_ID = 'YOUR_SERVICE_ID_HERE';             // e.g. service_abc123
    const CLIENT_TEMPLATE_ID = 'YOUR_CLIENT_TEMPLATE_ID';  // Template for client email
    const NADINE_TEMPLATE_ID = 'YOUR_NADINE_TEMPLATE_ID';  // Can be same as client or separate

    const EMAIL_CONFIG = {
      nadineEmail: 'nadine@cyberly.co.za'
    };

    // Initialise EmailJS
    (function(){
      emailjs.init(EMAILJS_USER_ID);
    })();

    // ==================== SCORING CONFIG, PILLAR MAPPING, RECOMMENDATIONS (unchanged) ====================
    // (all your original scoringConfig, pillarMapping, pillarRecommendations remain exactly the same)

    let currentQuestion = 0;
    const totalQuestions = 26;
    let answers = {};
    let overallScore = 0;
    let pillarScores = {};
    let generatedPDF = null;

    // ==================== UPDATED generatePDF - MULTI-PAGE SUPPORT ====================
    async function generatePDF(download = true) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const element = document.getElementById('results');

      const pdfBtn = document.getElementById('pdfBtn');
      const originalBtnText = pdfBtn.textContent;
      pdfBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';
      pdfBtn.disabled = true;

      try {
        // Temporarily hide buttons/form/notice so PDF is clean
        const toHide = document.querySelectorAll('.download-section, .email-form, .auto-email-notice');
        const originalDisplays = [];
        toHide.forEach(el => {
          originalDisplays.push(el.style.display);
          el.style.display = 'none';
        });

        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        });

        // Restore visibility
        toHide.forEach((el, i) => el.style.display = originalDisplays[i]);

        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 190;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        const pageHeight = 277; // usable height on A4

        let heightLeft = imgHeight;
        let position = 10;

        // First page
        doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // Additional pages
        while (heightLeft > 0) {
          doc.addPage();
          position = heightLeft - imgHeight + 10;
          doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // Header & footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(20);
          doc.setTextColor(0, 85, 165);
          if (i === 1) doc.text('Cyber Security Maturity Assessment Report', 105, 20, { align: 'center' });
          doc.setFontSize(10);
          doc.setTextColor(100);
          doc.text('Generated on ' + new Date().toLocaleDateString(), 105, 290, { align: 'center' });
        }

        generatedPDF = doc;

        if (download) {
          doc.save(`CyberSecurity_Maturity_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        }
      } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF. Please try again.');
      } finally {
        pdfBtn.textContent = originalBtnText;
        pdfBtn.disabled = false;
      }
    }

    // ==================== EMAIL SENDING FUNCTIONS ====================
    async function sendReportToClient() {
      const clientEmail = document.getElementById('clientEmail').value.trim();
      const button = document.querySelector('.email-button');
      const originalText = button.textContent;

      if (!clientEmail || !isValidEmail(clientEmail)) {
        document.getElementById('emailError').textContent = 'Please enter a valid email address.';
        document.getElementById('emailError').style.display = 'block';
        return;
      }

      button.innerHTML = '<span class="loading-spinner"></span> Sending...';
      button.disabled = true;
      document.getElementById('emailSuccess').style.display = 'none';
      document.getElementById('emailError').style.display = 'none';

      try {
        if (!generatedPDF) await generatePDF(false);

        const pdfBlob = generatedPDF.output('blob');
        const base64 = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(pdfBlob);
        });

        await emailjs.send(SERVICE_ID, CLIENT_TEMPLATE_ID, {
          to_email: clientEmail,
          overall_score: overallScore + '%',
          maturity_level: getMaturityLevel(overallScore)
          // Add any other template variables you created
        }, {
          attachments: [{
            name: 'Cyber_Security_Maturity_Report.pdf',
            data: base64
          }]
        });

        document.getElementById('emailSuccess').textContent = `✅ Report sent to ${clientEmail}`;
        document.getElementById('emailSuccess').style.display = 'block';
      } catch (err) {
        console.error(err);
        document.getElementById('emailError').textContent = '❌ Failed to send. Please download the PDF instead.';
        document.getElementById('emailError').style.display = 'block';
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    async function sendReportToNadine(clientEmail = 'Not provided') {
      if (!generatedPDF) return;

      try {
        const pdfBlob = generatedPDF.output('blob');
        const base64 = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(pdfBlob);
        });

        await emailjs.send(SERVICE_ID, NADINE_TEMPLATE_ID, {
          to_email: EMAIL_CONFIG.nadineEmail,
          client_email: clientEmail,
          overall_score: overallScore + '%',
          maturity_level: getMaturityLevel(overallScore)
        }, {
          attachments: [{
            name: 'Cyber_Security_Maturity_Report.pdf',
            data: base64
          }]
        });
      } catch (err) {
        console.error('Failed to auto-send to Nadine:', err);
      }
    }

    // ==================== SHOW RESULTS - AUTO SEND TO NADINE ====================
    function showResultsPage() {
      document.getElementById('final').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      updateUI();

      pillarScores = calculatePillarScores();
      overallScore = calculateOverallScore(pillarScores);

      document.getElementById('overall-score').textContent = `${overallScore}%`;
      document.getElementById('maturity-level').textContent = getMaturityLevel(overallScore);

      displayPillarScores(pillarScores);
      generateRecommendations(pillarScores, overallScore);

      // Auto-generate PDF and send to Nadine
      generatePDF(false).then(() => {
        sendReportToNadine();
        document.getElementById('autoEmailNotice').style.display = 'block';
      });
    }

    // ==================== REST OF ORIGINAL SCRIPT (unchanged except minor calls) ====================
    // startAssessment, retakeAssessment, next/prevQuestion, calculations, etc. remain exactly as you had them
    // Only change: onclick for buttons
    // PDF button: onclick="generatePDF()"
    // Email button: onclick="sendReportToClient()"

    // ... (all other original functions unchanged)

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.answer input').forEach(inp => {
        inp.addEventListener('change', () => {
          const answer = inp.closest('.answer');
          answer.classList.toggle('selected', inp.checked);
          if (inp.type === 'radio') {
            document.querySelectorAll(`input[name="${inp.name}"]`).forEach(r => {
              if (r !== inp) r.closest('.answer').classList.remove('selected');
            });
          }
        });
      });

      document.querySelectorAll('.uncheck-all input').forEach(ex => {
        ex.addEventListener('change', function() {
          if (this.checked) {
            const q = this.name;
            document.querySelectorAll(`input[name="${q}"]:not(.uncheck-all input)`).forEach(inp => {
              inp.checked = false;
              inp.closest('.answer').classList.remove('selected');
            });
          }
        });
      });

      updateUI();
    });
  </script>
</body>
</html>

